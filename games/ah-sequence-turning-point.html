<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>American Studies — Game 4: Sequence & Turning Points (Mastery)</title>

  <!-- ✅ SAME working pattern -->
  <link rel="stylesheet" href="../styles.css">

  <!-- ✅ Fallback styling so it never looks “blank” even if CSS fails -->
  <style>
    :root{
      --bg:#0b1220; --text:#e7eefc; --muted:#a8b4cf;
      --line:rgba(255,255,255,.12); --radius:18px;
      --accent:#7aa2ff; --good:#2bd576; --bad:#ff5c7a; --warn:#ffd166;
    }
    body{
      margin:0;
      background:radial-gradient(1200px 800px at 30% 10%, rgba(122,162,255,.18), transparent 60%), var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:18px;
    }
    .gameShell{ width:min(980px,100%); }
    .panel{
      background:rgba(17,26,47,.72);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:0 12px 35px rgba(0,0,0,.25);
      padding:16px;
    }
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between}
    .kpis{display:flex; gap:10px; flex-wrap:wrap}
    .kpi{
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(255,255,255,.05);
      color:var(--muted);
      font-size:13px;
    }
    .kpi strong{color:var(--text)}
    .title{font-weight:900; font-size:18px}
    .desc{color:var(--muted); margin-top:2px; font-size:13px}
    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-size:13px;
      margin-top:8px;
    }
    .hr{height:1px; background:var(--line); margin:14px 0}

    .qwrap{margin-top:14px}
    .qmeta{display:flex; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:13px}
    .stem{margin-top:10px; font-size:18px; line-height:1.35; font-weight:900;}
    .mini{margin-top:8px; color:var(--muted); font-size:13px; line-height:1.4}

    .choices{display:grid; gap:10px; margin-top:12px}
    .choice{
      text-align:left;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      transition:transform .08s ease, border-color .12s ease, background .12s ease;
      font-size:15px;
      line-height:1.35;
    }
    .choice:hover{transform:translateY(-1px); border-color:rgba(122,162,255,.35)}
    .choice[disabled]{opacity:.55; cursor:not-allowed; transform:none}

    .msg{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:rgba(0,0,0,.18);
      color:var(--muted);
      line-height:1.45;
    }
    .msg.good{border-color:rgba(43,213,118,.35)}
    .msg.bad{border-color:rgba(255,92,122,.35)}
    .msg.warn{border-color:rgba(255,209,102,.35)}
    .msgTitle{font-weight:900; margin-bottom:6px; color:var(--text)}

    .hintBox{
      margin-top:10px;
      border:1px dashed rgba(255,209,102,.45);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(255,209,102,.06);
      color:var(--muted);
      display:none;
    }

    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
    }
    .btn:hover{border-color:rgba(122,162,255,.35)}
    .btn.primary{background:rgba(122,162,255,.18); border-color:rgba(122,162,255,.35)}
    .btn.good{background:rgba(43,213,118,.14); border-color:rgba(43,213,118,.35)}
    .btn.bad{background:rgba(255,92,122,.12); border-color:rgba(255,92,122,.35)}
    .btn[disabled]{opacity:.5; cursor:not-allowed}

    .nameGate{display:grid; gap:10px; margin-top:10px;}
    input[type="text"]{
      width:min(420px,100%);
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
      font-size:15px;
    }
    .small{font-size:13px; color:var(--muted)}

    .finishCard{
      margin-top:14px;
      padding:14px;
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
    }
    .code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:13px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      overflow:auto;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
  <div class="gameShell">
    <div class="panel">

      <div class="row">
        <div>
          <div class="title">American Studies — Game 4</div>
          <div class="desc">Sequence & Turning Points • timeline logic • 100% mastery required</div>
          <div class="pill">Directions: Choose the answer that correctly identifies the sequence/turning-point logic.</div>
        </div>
        <div class="kpis">
          <div class="kpi"><strong>Name:</strong> <span id="nameOut">—</span></div>
          <div class="kpi"><strong>Score:</strong> <span id="scoreOut">0 / 0</span></div>
          <div class="kpi"><strong>Accuracy:</strong> <span id="accOut">0%</span></div>
          <div class="kpi"><strong>Progress:</strong> <span id="progOut">0 / 0</span></div>
        </div>
      </div>

      <div class="hr"></div>

      <!-- NAME GATE -->
      <div id="gate">
        <div class="msg warn">
          <div class="msgTitle">Start</div>
          <div>Enter your name to begin. Questions are randomized each run. Mastery requires <strong>100% accuracy</strong> across all questions.</div>
        </div>
        <div class="nameGate">
          <input id="nameIn" type="text" placeholder="Student Name" maxlength="40" />
          <div class="actions">
            <button class="btn primary" id="btnStart">Start Game</button>
          </div>
        </div>
      </div>

      <!-- GAME -->
      <div id="game" style="display:none;">
        <div class="qwrap">
          <div class="qmeta">
            <div><strong>Question:</strong> <span id="qNum">1</span> / <span id="qTotal">0</span></div>
            <div><strong>Attempt on this question:</strong> <span id="attemptThis">0</span></div>
          </div>

          <div class="stem" id="stem">—</div>
          <div class="mini" id="prompt">—</div>

          <div class="choices" id="choices"></div>

          <div class="hintBox" id="hintBox"></div>

          <div class="msg" id="feedback" style="display:none;">
            <div class="msgTitle" id="fbTitle">—</div>
            <div id="fbText">—</div>
          </div>

          <div class="actions">
            <button class="btn bad" id="btnRestart">Restart Run</button>
            <button class="btn good" id="btnFinish" disabled>Finish / Submit</button>
          </div>

          <div class="small" style="margin-top:10px;">
            Mastery unlocks only when <strong>all questions are completed</strong> and <strong>accuracy is 100%</strong>.
          </div>
        </div>

        <!-- FINISH SCREEN -->
        <div id="finish" style="display:none;">
          <div class="finishCard">
            <div class="msgTitle">Run Summary</div>
            <div class="small" id="summaryLine">—</div>
            <div class="hr"></div>
            <div class="code" id="summaryCode">—</div>
            <div class="actions" style="margin-top:12px;">
              <button class="btn primary" id="btnNewRun">New Randomized Run</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
(function(){
  "use strict";

  /* =========================================================
     GAME 4 — Sequence & Turning Points (Mastery Shell)
     - Single best answer (A-D)
     - Miss counts once per question (first incorrect attempt)
     - Correct first try -> 3s explanation -> auto advance
     - Correct after miss -> brief pause -> advance
     ========================================================= */

  // ✅ TEST SET (10) — swap to full 25–30 after you confirm it runs
  var questions = [
  // 1
  {
    stem:"Which sequence BEST represents a typical pattern of urban growth during industrialization?",
    prompt:"Choose the option that places events in the most logical order.",
    choices:{
      A:"Factories expand → demand for workers rises → migration to cities increases → overcrowding and tenements grow",
      B:"Tenements expand → factories close → workers leave cities → city populations rise",
      C:"Sanitation improves → disease increases → immigration ends → cities grow",
      D:"Cities shrink → mechanized farming increases farm labor needs → factories expand"
    },
    answer:"A",
    hint:"Jobs pull people into cities; housing struggles to keep up.",
    explain:"Industrial jobs drew workers to cities; rapid growth created overcrowding and tenement expansion."
  },

  // 2
  {
    stem:"Which turning point MOST directly increased the speed of urbanization in the late 1800s?",
    prompt:"A turning point is a change that causes major effects afterward.",
    choices:{
      A:"Mechanized farming reduced the need for rural labor",
      B:"A drop in factory production in northern cities",
      C:"A ban on immigration to the United States",
      D:"A law requiring workers to return to farms"
    },
    answer:"A",
    hint:"Think: a change that pushes people off farms.",
    explain:"Mechanized farming reduced rural jobs, pushing people toward city work and accelerating urbanization."
  },

  // 3
  {
    stem:"Which sequence BEST explains how crowded housing contributed to disease outbreaks in cities?",
    prompt:"Choose the option that correctly shows cause → effect over time.",
    choices:{
      A:"Overcrowding rises → sanitation systems are overwhelmed → water/air quality worsens → disease spreads",
      B:"Disease decreases → sanitation collapses → overcrowding ends → cities shrink",
      C:"Clean water expands → sanitation improves → disease increases → overcrowding rises",
      D:"Cities shrink → tenements expand → public health improves → disease spreads"
    },
    answer:"A",
    hint:"Rapid growth strains infrastructure first.",
    explain:"Overcrowding often overwhelmed sanitation and clean water, increasing disease spread like cholera and tuberculosis."
  },

  // 4
  {
    stem:"Which turning point BEST explains why labor unions expanded during industrialization?",
    prompt:"Choose the option that represents a key cause of union growth.",
    choices:{
      A:"Unsafe conditions and long hours led workers to organize for reforms",
      B:"Employers voluntarily improved wages and safety nationwide",
      C:"The government immediately enforced strong labor protections everywhere",
      D:"Industrial jobs disappeared, ending workplace conflict"
    },
    answer:"A",
    hint:"Unions grow when workers need collective leverage.",
    explain:"Harsh working conditions and low pay pushed workers to organize for bargaining power and reforms."
  },

  // 5
  {
    stem:"Which sequence BEST explains how laissez-faire policies contributed to trusts and monopolies?",
    prompt:"Choose the option that correctly connects policy to business outcomes.",
    choices:{
      A:"Limited regulation → corporations expand rapidly → consolidation increases → trusts/monopolies form",
      B:"Strict regulation → corporations expand rapidly → competition increases → monopolies form",
      C:"High tariffs → unions weaken → factories close → trusts expand",
      D:"Elections end → regulation increases → monopolies disappear"
    },
    answer:"A",
    hint:"Hands-off oversight allows consolidation.",
    explain:"Laissez-faire reduced oversight, enabling rapid growth and consolidation into trusts and monopolies."
  },

  // 6
  {
    stem:"Which sequence BEST explains a push-pull pattern behind the Great Migration?",
    prompt:"Choose the option that correctly identifies push factors followed by pull factors.",
    choices:{
      A:"Jim Crow violence/segregation → people leave the South → northern industrial jobs → migration increases",
      B:"Northern jobs disappear → people leave the North → discrimination ends in the South → migration increases",
      C:"Segregation ends in the South → people leave anyway → farms expand → migration increases",
      D:"Factory wages drop in the North → workers move South → Jim Crow expands → migration increases"
    },
    answer:"A",
    hint:"Push = oppression; pull = jobs.",
    explain:"Oppression pushed migrants out of the South, while northern job opportunities pulled them to cities."
  },

  // 7
  {
    stem:"Which turning point BEST explains why Progressive reforms gained support?",
    prompt:"Choose the event/change that most increased demand for reform.",
    choices:{
      A:"Public exposure of corruption and unsafe conditions increased pressure for change",
      B:"All political corruption ended in major cities",
      C:"Corporations removed themselves from politics voluntarily",
      D:"Industrial workplaces disappeared nationwide"
    },
    answer:"A",
    hint:"What made people demand action?",
    explain:"Investigations and publicity about corruption and dangers increased public pressure for reforms."
  },

  // 8
  {
    stem:"Which sequence BEST explains how new technology changed daily life during industrialization?",
    prompt:"Choose the option that shows technology → change in behavior/markets.",
    choices:{
      A:"Electricity expands → appliances become common → home tasks become easier → consumer markets grow",
      B:"Appliances vanish → electricity expands → home tasks become harder → markets grow",
      C:"Cities shrink → automobiles vanish → travel expands → markets grow",
      D:"Communication declines → radios expand → information slows → markets shrink"
    },
    answer:"A",
    hint:"Technology often reduces time/cost, expanding markets.",
    explain:"Electricity enabled new appliances, improving convenience and helping expand consumer markets."
  },

  // 9
  {
    stem:"Which turning point BEST explains why the reservation system expanded in the West?",
    prompt:"Choose the policy shift with major effects afterward.",
    choices:{
      A:"Federal policy increasingly confined tribes to specific lands as settlement expanded",
      B:"The government ended westward settlement to protect tribal lands",
      C:"All treaties guaranteed tribal sovereignty permanently with strong enforcement",
      D:"Settlers avoided tribal lands, reducing conflict"
    },
    answer:"A",
    hint:"Settlement pressure → forced confinement.",
    explain:"Expansion increased conflict and land pressure, leading to federal policies that confined tribes to reservations."
  },

  // 10
  {
    stem:"Which sequence BEST explains how Plessy v. Ferguson reinforced segregation?",
    prompt:"Choose the option that links law → court decision → outcome.",
    choices:{
      A:"Jim Crow expands → Plessy upholds 'separate but equal' → segregation strengthens",
      B:"Segregation ends → Plessy bans discrimination → Jim Crow expands",
      C:"Voting rights expand → Plessy protects equality → segregation increases",
      D:"Reconstruction continues → Plessy ends Jim Crow → equality achieved"
    },
    answer:"A",
    hint:"Plessy supported segregation, not equality.",
    explain:"Plessy upheld segregation, helping Jim Crow laws and practices continue and expand."
  },

  // 11
  {
    stem:"Which sequence BEST explains why tenement housing became widespread?",
    prompt:"Choose the most logical cause → effect order.",
    choices:{
      A:"City populations rise quickly → housing demand increases → cheap crowded buildings built → living conditions worsen",
      B:"Living conditions improve → housing demand drops → tenements spread",
      C:"Tenements disappear → populations rise → jobs vanish → cities grow",
      D:"Housing supply increases greatly → overcrowding increases → demand falls"
    },
    answer:"A",
    hint:"Fast growth → cheap housing built quickly.",
    explain:"Rapid urban growth increased housing demand, and inexpensive crowded tenements were built near jobs."
  },

  // 12
  {
    stem:"Which turning point MOST directly increased nativist tension in some cities?",
    prompt:"Choose the change most likely to create backlash.",
    choices:{
      A:"A rise in immigration that increased competition for jobs and housing",
      B:"A sharp decrease in city populations",
      C:"An end to cultural diversity in urban neighborhoods",
      D:"Immediate elimination of discrimination and inequality"
    },
    answer:"A",
    hint:"Competition and unfamiliarity can fuel backlash.",
    explain:"Large immigration waves sometimes increased job/housing competition and cultural tension, fueling nativism."
  },

  // 13
  {
    stem:"Which sequence BEST explains how unions used strikes as a tactic?",
    prompt:"Choose the order that matches a typical strike strategy.",
    choices:{
      A:"Workers stop work → production slows → employer loses profit → negotiations become more likely",
      B:"Employers raise wages → workers strike → production increases → negotiations end",
      C:"Government bans unions → wages rise → strikes begin → reforms happen",
      D:"Workers stop work → profits rise → employers refuse to negotiate → wages rise"
    },
    answer:"A",
    hint:"A strike creates leverage by stopping production.",
    explain:"Strikes pressured employers by disrupting production and profits, encouraging negotiation for reforms."
  },

  // 14
  {
    stem:"Which turning point MOST directly encouraged the growth of large corporations during industrialization?",
    prompt:"Choose the factor that allowed expansion and consolidation.",
    choices:{
      A:"Limited government regulation of business practices",
      B:"A nationwide ban on railroads and shipping",
      C:"The end of mass production in factories",
      D:"Strict enforcement of anti-monopoly laws before 1870"
    },
    answer:"A",
    hint:"Think: fewer limits allowed faster growth.",
    explain:"Laissez-faire ideas and limited regulation helped corporations grow quickly and consolidate power."
  },

  // 15
  {
    stem:"Which sequence BEST explains how the Dawes Act connects to assimilation policies?",
    prompt:"Choose the option that matches allotment → cultural pressure.",
    choices:{
      A:"Tribal lands divided into individual plots → traditional communal life disrupted → assimilation pressures increase",
      B:"Communal lands protected → tribal governments strengthened → assimilation ends",
      C:"Land returned to tribes → reservations expand → conflicts disappear",
      D:"Railroads end → farming declines → allotment disappears"
    },
    answer:"A",
    hint:"Allotment undermined communal land and culture.",
    explain:"Allotment broke up communal landholding and pressured Native people toward Euro-American farming and assimilation."
  },

  // 16
  {
    stem:"Which turning point MOST directly contributed to the end of Reconstruction’s protections in the South?",
    prompt:"Choose the change that reduced enforcement of civil rights.",
    choices:{
      A:"Federal enforcement weakened, allowing state/local discrimination to expand",
      B:"Federal troops expanded in the South, enforcing desegregation",
      C:"The Supreme Court banned segregation nationwide",
      D:"Voting rights expanded without restriction across the South"
    },
    answer:"A",
    hint:"Less enforcement → more discriminatory laws.",
    explain:"Reduced federal enforcement after Reconstruction enabled Jim Crow laws and discriminatory practices to spread."
  },

  // 17
  {
    stem:"Which sequence BEST explains how Progressive-era consumer protection laws developed?",
    prompt:"Choose the order that fits problem → exposure → reform.",
    choices:{
      A:"Unsafe/unclean products → public outrage grows → government passes safety/labeling laws → consumer protection increases",
      B:"Reforms pass first → unsafe products increase → public stops caring → protection decreases",
      C:"Businesses self-regulate fully → government bans inspections → protection increases",
      D:"Public outrage declines → laws pass → unsafe products disappear instantly"
    },
    answer:"A",
    hint:"Reforms often follow exposure and pressure.",
    explain:"Public awareness of unsafe products increased demand for reforms, leading to laws that improved safety and labeling."
  },

  // 18
  {
    stem:"Which turning point MOST directly encouraged the growth of settlement houses?",
    prompt:"Choose the problem that created the need for these services.",
    choices:{
      A:"Rapid urbanization and immigration created needs for education and community support",
      B:"A complete end to urban poverty and overcrowding",
      C:"A disappearance of immigrant neighborhoods in cities",
      D:"The elimination of social problems caused by industrialization"
    },
    answer:"A",
    hint:"Settlement houses address needs in crowded immigrant areas.",
    explain:"Urban growth and immigration created needs for services; settlement houses provided support and education."
  },

  // 19
  {
    stem:"Which sequence BEST explains how transportation improvements supported urban growth?",
    prompt:"Choose the option that connects movement → expansion.",
    choices:{
      A:"Transportation improves → workers can travel farther → city areas expand → urban population grows",
      B:"Transportation worsens → workers travel farther → cities expand faster",
      C:"Transportation improves → factories close → urban population declines",
      D:"Transportation ends → commuting increases → cities expand"
    },
    answer:"A",
    hint:"Better travel increases commuting and city expansion.",
    explain:"Improved transportation let people commute, enabling cities to spread outward and continue growing."
  },

  // 20
  {
    stem:"Which turning point MOST directly increased public support for antitrust action?",
    prompt:"Choose the change that made monopoly power seem harmful.",
    choices:{
      A:"Public concerns grew that trusts limited competition and abused economic power",
      B:"Monopolies disappeared from the economy entirely",
      C:"All prices became equal across industries immediately",
      D:"Competition ended because small businesses gained complete control"
    },
    answer:"A",
    hint:"Antitrust targets abuse of concentrated power.",
    explain:"Growing concern about trust power and unfair practices increased demand for antitrust enforcement."
  },

  // 21
  {
    stem:"Which sequence BEST explains how urbanization changed social and cultural life in cities?",
    prompt:"Choose the most logical order.",
    choices:{
      A:"Migration increases → ethnic neighborhoods form → cultural diffusion occurs → cities become more diverse",
      B:"Cultural diffusion ends → ethnic neighborhoods disappear → migration increases → cities diversify",
      C:"Cities become less diverse → neighborhoods form → migration stops → diffusion grows",
      D:"Neighborhoods disappear → migration stops → diversity increases → diffusion ends"
    },
    answer:"A",
    hint:"New arrivals cluster, then culture spreads.",
    explain:"Migration produced ethnic neighborhoods, and cultural traits diffused into broader city culture."
  },

  // 22
  {
    stem:"Which turning point MOST directly increased the likelihood of violent labor conflict in some strikes?",
    prompt:"Choose the factor most likely to escalate a dispute.",
    choices:{
      A:"Employers and authorities resisted strikes, sometimes using force to protect production and property",
      B:"All strikes ended immediately with peaceful agreements",
      C:"Workers stopped using collective tactics in disputes",
      D:"Factories closed permanently before any strike occurred"
    },
    answer:"A",
    hint:"Resistance and force can escalate conflict.",
    explain:"Employer/government resistance to strikes sometimes escalated tensions into violent confrontations."
  },

  // 23
  {
    stem:"Which sequence BEST explains how Jim Crow and voting restrictions reinforced discrimination?",
    prompt:"Choose the cause → effect order.",
    choices:{
      A:"Segregation laws expand → voting barriers increase → political power decreases → inequality is reinforced",
      B:"Voting rights expand → segregation ends → inequality increases → reforms disappear",
      C:"Equality increases → barriers increase → power increases → segregation ends",
      D:"Barriers disappear → segregation expands → power decreases → equality increases"
    },
    answer:"A",
    hint:"Less political power makes change harder.",
    explain:"Segregation and voting barriers reduced political influence, reinforcing discriminatory systems."
  },

  // 24
  {
    stem:"Which turning point MOST directly encouraged internal migration from farms to cities?",
    prompt:"Choose the change that reduced rural job opportunities.",
    choices:{
      A:"Mechanized farming reduced the demand for farm labor",
      B:"A nationwide increase in small family farms requiring more workers",
      C:"The disappearance of city factory jobs",
      D:"A law banning movement between states"
    },
    answer:"A",
    hint:"Mechanization = fewer workers needed.",
    explain:"Farm mechanization reduced rural labor demand, pushing many people toward urban industrial work."
  },

  // 25
  {
    stem:"Which sequence BEST explains how reformers used evidence to create Progressive change?",
    prompt:"Choose the order that matches the reform process.",
    choices:{
      A:"Problems investigated → abuses exposed publicly → voters demand action → laws/regulations expand",
      B:"Laws expand first → investigation begins → public ignores → problems grow",
      C:"Public ignores problems → reforms pass → abuses increase → investigation ends",
      D:"Abuses disappear first → exposure begins → demand falls → reforms expand"
    },
    answer:"A",
    hint:"Expose problems → demand action → pass reforms.",
    explain:"Progressive change often followed investigation and exposure, which increased public pressure for reform laws."
  }
];


  function $(id){ return document.getElementById(id); }

  var state = {
    player:"",
    startISO:null,
    endISO:null,
    order:[],
    idx:0,
    correct:0,
    misses:0,
    missedSet:{},
    attemptThis:0,
    locked:false,
    timer:null
  };

  function nowISO(){ return new Date().toISOString(); }
  function fmt(dt){ return new Date(dt).toLocaleString(); }

  function shuffle(arr){
    var a = arr.slice();
    for(var i=a.length-1;i>0;i--){
      var j = Math.floor(Math.random()*(i+1));
      var tmp = a[i]; a[i]=a[j]; a[j]=tmp;
    }
    return a;
  }

  function calcAcc(){
    var totalQ = questions.length;
    var perfectCorrect = totalQ - state.misses;
    var acc = Math.round((perfectCorrect / totalQ) * 100);
    if(acc<0) acc=0; if(acc>100) acc=100;
    return acc;
  }

  function updateKPIs(){
    $("nameOut").textContent = state.player || "—";
    $("scoreOut").textContent = state.correct + " / " + questions.length;
    $("accOut").textContent = calcAcc() + "%";
    $("progOut").textContent = state.idx + " / " + questions.length;
  }

  function showFeedback(type, title, text){
    var box = $("feedback");
    box.style.display = "block";
    box.className = "msg " + type;
    $("fbTitle").textContent = title;
    $("fbText").textContent = text;
  }
  function hideFeedback(){ $("feedback").style.display = "none"; }

  function setHint(text){
    var hb = $("hintBox");
    if(!text){
      hb.style.display = "none";
      hb.textContent = "";
      return;
    }
    hb.style.display = "block";
    hb.textContent = "Hint: " + text;
  }

  function disableChoices(disabled){
    var btns = $("choices").querySelectorAll("button.choice");
    for(var i=0;i<btns.length;i++) btns[i].disabled = disabled;
  }

  function renderQuestion(){
    hideFeedback();
    setHint("");
    state.attemptThis = 0;
    $("attemptThis").textContent = "0";

    var qIndex = state.order[state.idx];
    var q = questions[qIndex];

    $("qNum").textContent = String(state.idx + 1);
    $("qTotal").textContent = String(questions.length);
    $("stem").textContent = q.stem;
    $("prompt").textContent = q.prompt || "";

    var html = "";
    var keys = ["A","B","C","D"];
    for(var k=0;k<keys.length;k++){
      var key = keys[k];
      html += '<button class="choice" data-key="' + key + '"><strong>' + key + '.</strong> ' + q.choices[key] + '</button>';
    }
    $("choices").innerHTML = html;

    var btns = $("choices").querySelectorAll("button.choice");
    for(var i=0;i<btns.length;i++){
      btns[i].addEventListener("click", function(){
        if(state.locked) return;
        checkAnswer(this.getAttribute("data-key"));
      });
    }

    updateKPIs();
  }

  function updateFinishLock(){
    var acc = calcAcc();
    var doneAll = state.idx >= questions.length;
    var mastery = doneAll && acc === 100;

    $("btnFinish").disabled = !mastery;

    if(doneAll){
      if(mastery){
        showFeedback("good","Mastery reached","100% accuracy across the full run. Click Finish / Submit.");
      }else{
        showFeedback("warn","Run complete — not mastery",
          "You finished the run, but accuracy is " + acc + "%. Start a new randomized run and try for 100%.");
      }
    }
  }

  function advance(){
    state.idx++;
    updateKPIs();

    if(state.idx >= questions.length){
      disableChoices(true);
      setHint("");
      updateFinishLock();
      return;
    }
    renderQuestion();
  }

  function checkAnswer(choice){
    var qIndex = state.order[state.idx];
    var q = questions[qIndex];

    state.attemptThis++;
    $("attemptThis").textContent = String(state.attemptThis);

    var correctNow = (choice === q.answer);

    if(correctNow){
      state.correct = Math.min(questions.length, state.correct + 1);
      updateKPIs();

      disableChoices(true);
      state.locked = true;

      var firstTry = (state.attemptThis === 1);
      clearTimeout(state.timer);

      if(firstTry){
        showFeedback("good","Correct (first try)", q.explain || "Correct.");
        state.timer = setTimeout(function(){
          state.locked = false;
          disableChoices(false);
          advance();
        }, 3000);
      }else{
        showFeedback("good","Correct (after hint)", q.explain || "Correct.");
        state.timer = setTimeout(function(){
          state.locked = false;
          disableChoices(false);
          advance();
        }, 800);
      }
      return;
    }

    if(!state.missedSet[qIndex]){
      state.missedSet[qIndex] = true;
      state.misses++;
      updateKPIs();
    }

    showFeedback("bad","Not yet","Use the hint and try again. Your accuracy will reflect this miss.");
    setHint(q.hint || "Identify the correct cause → effect or timeline order, then choose the BEST match.");
  }

  function startRun(){
    var idxs = [];
    for(var i=0;i<questions.length;i++) idxs.push(i);
    state.order = shuffle(idxs);

    state.idx = 0;
    state.correct = 0;
    state.misses = 0;
    state.missedSet = {};
    state.attemptThis = 0;
    state.locked = false;
    clearTimeout(state.timer);
    state.timer = null;

    state.startISO = nowISO();
    state.endISO = null;

    $("finish").style.display = "none";
    renderQuestion();
  }

  function finishRun(){
    state.endISO = nowISO();

    var acc = calcAcc();
    var mastery = (acc === 100 && state.idx >= questions.length);

    $("summaryLine").textContent = mastery
      ? "Mastery earned. Show this screen to your teacher."
      : "Not mastery. Start a new randomized run and try again.";

    $("summaryCode").textContent =
      "NAME: " + state.player + "\n" +
      "GAME: Game 4 — Sequence & Turning Points\n" +
      "DATE: " + new Date(state.startISO).toLocaleDateString() + "\n" +
      "START: " + fmt(state.startISO) + "\n" +
      "END: " + fmt(state.endISO) + "\n" +
      "QUESTIONS: " + questions.length + "\n" +
      "MISSES: " + state.misses + "\n" +
      "ACCURACY: " + acc + "%\n" +
      "MASTERY: " + (mastery ? "YES" : "NO") + "\n";

    $("finish").style.display = "block";
    $("choices").innerHTML = "";
    setHint("");
  }

  document.addEventListener("DOMContentLoaded", function(){
    $("btnStart").addEventListener("click", function(){
      var name = $("nameIn").value.trim();
      if(!name){ alert("Please enter your name to begin."); return; }
      state.player = name;
      $("gate").style.display = "none";
      $("game").style.display = "block";
      startRun();
    });

    $("btnRestart").addEventListener("click", function(){
      if(confirm("Restart with a new randomized run?")) startRun();
    });

    $("btnFinish").addEventListener("click", finishRun);
    $("btnNewRun").addEventListener("click", startRun);

    updateKPIs();
  });

})();
</script>
</body>
</html>

